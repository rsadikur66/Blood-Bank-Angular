using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Web;

namespace BloodBankDAL.Repository.Query.Query
{
    public class Q12207:CommonDAL
    {
        public DataTable GetGridData()
        {
            //DataTable dt1 =
            //    Query(
            //        $"SELECT T12065.T_BLOOD_REQNO, T12065.T_BLOOD_REQDATE, T12065.T_BLOOD_REQTIME, T12065.T_SITE_CODE TRANS_HOSP, T12065.T_REF_HOSP CENT_HOSP, (SELECT T02049.T_LANG2_NAME FROM T02049 WHERE T02049.T_REFERRAL_CODE = T12065.T_SITE_CODE) TRANS_HOSP_NAME, (SELECT T02049.T_LANG2_NAME FROM T02049 WHERE T02049.T_REFERRAL_CODE = T12065.T_REF_HOSP) CENTR_HOSP_NAME, T12065.T_BB_RECEIVED_DATE REQ_RCV_DATE, T12065.T_BB_RECEIVED_TIME REQ_RCV_TIME,T12065.T_BB_RECEIVED_FLAG REQ_RCV_FLAG, (SELECT MAX(T12067.T_BB_ISSUED_DATE) FROM T12067 WHERE T12067.T_SITE_CODE = T12065.T_SITE_CODE AND T12067.T_BLOOD_REQNO = T12065.T_BLOOD_REQNO)  T_BB_ISSUED_DATE,T12067.T_BB_ISSUED_TIME, (SELECT MAX(T12067.T_HOSP_RECEIVED_DATE) FROM T12067 WHERE T12067.T_SITE_CODE = T12065.T_SITE_CODE AND T12067.T_BLOOD_REQNO = T12065.T_BLOOD_REQNO)  OUT_RCV_DATE, T12067.T_HOSP_RECEIVED_TIME OUT_RCV_TIME,T12065.T_REQUEST_STATUS FROM T12065 LEFT JOIN T12067 on T12065.T_SITE_CODE = T12067.T_SITE_CODE WHERE T_BLOOD_REQDATE BETWEEN to_date('{FromDate}', 'dd/MM/yyyy') AND to_date('{ToDate}', 'dd/MM/yyyy')");

            //DataTable dt2 = Query($"SELECT DISTINCT T12065.T_BLOOD_REQNO, T12065.T_BLOOD_REQDATE, T12065.T_BLOOD_REQTIME, T12065.T_SITE_CODE TRANS_HOSP, T12065.T_REF_HOSP CENT_HOSP, (SELECT T02049.T_LANG2_NAME FROM T02049 WHERE T02049.T_REFERRAL_CODE = T12065.T_SITE_CODE) TRANS_HOSP_NAME, (SELECT T02049.T_LANG2_NAME FROM T02049 WHERE T02049.T_REFERRAL_CODE = T12065.T_REF_HOSP) CENTR_HOSP_NAME, T12065.T_BB_RECEIVED_DATE REQ_RCV_DATE, T12065.T_BB_RECEIVED_TIME REQ_RCV_TIME, T12065.T_BB_RECEIVED_FLAG REQ_RCV_FLAG, (SELECT MAX(T12067.T_BB_ISSUED_DATE) FROM T12067 WHERE T12067.T_SITE_CODE = T12065.T_SITE_CODE AND T12067.T_BLOOD_REQNO = T12065.T_BLOOD_REQNO) T_BB_ISSUED_DATE, T12067.T_BB_ISSUED_TIME, (SELECT MAX(T12065.T_TF_RECEIVE_DATE) FROM T12067 WHERE T12067.T_SITE_CODE = T12065.T_SITE_CODE AND T12067.T_BLOOD_REQNO = T12065.T_BLOOD_REQNO) OUT_RCV_DATE, T12065.T_TF_RECEIVE_TIME OUT_RCV_TIME, T12065.T_REQUEST_STATUS FROM T12065 LEFT JOIN T12067 ON T12065.T_SITE_CODE = T12067.T_SITE_CODE AND T12065.T_BLOOD_REQNO = T12067.T_BLOOD_REQNO ORDER BY T_BLOOD_REQNO DESC");
            //return dt2;

            // Ruhul
            return Query($"SELECT DISTINCT T12065.T_BLOOD_REQNO, T12065.T_BLOOD_REQDATE, T12065.T_BLOOD_REQTIME, T12065.T_SITE_CODE TRANS_HOSP, T12065.T_REF_HOSP CENT_HOSP, (CASE WHEN T12065.T_REQUEST_STATUS = '1' THEN 'New Request' WHEN T12065.T_REQUEST_STATUS = '2' THEN 'Request Received' WHEN T12065.T_REQUEST_STATUS = '3' AND T12091.T_REQ_ACCEPT_FLG IS NULL THEN 'Issued' WHEN T12065.T_REQUEST_STATUS = '3' AND T12091.T_REQ_ACCEPT_FLG = '1' AND T12091.T_BLOOD_RCVD_FLG IS NULL THEN 'Delivery Accept' WHEN T12065.T_REQUEST_STATUS = '3' AND T12091.T_BLOOD_RCVD_FLG = '1' THEN 'Arrived' WHEN T12065.T_REQUEST_STATUS = '4' AND T12091.T_BLOOD_DROP_FLG IS NULL THEN 'Handovered' WHEN T12065.T_REQUEST_STATUS = '4' AND T12091.T_BLOOD_DROP_FLG = '1' THEN 'Dropped' WHEN T12065.T_REQUEST_STATUS = '5' THEN 'Out Received' ELSE ' ' END) T_STATUS, T12091.T_REQ_ACCEPT_FLG, T12091.T_BLOOD_RCVD_FLG, T12091.T_BLOOD_DROP_FLG, T12065.T_REQUEST_STATUS, T12065.T_DELIVERY_MAN, T01009.T_USER_NAME, T12091.T_REQ_ACCEPT_DATE, T12091.T_REQ_ACCEPT_TIME, T12065.T_BB_HANDOVER_DATE, T12065.T_BB_HANDOVER_TIME, T12091.T_BLOOD_RCVD_DATE, T12091.T_BLOOD_RCVD_TIME, T12091.T_BLOOD_DROP_DATE, T12091.T_BLOOD_DROP_TIME, T12065.T_TF_RECEIVE_DATE OUT_RCV_DATE, T12065.T_TF_RECEIVE_TIME OUT_RCV_TIME, (SELECT T02049.T_LANG2_NAME FROM T02049 WHERE T02049.T_REFERRAL_CODE = T12065.T_SITE_CODE) TRANS_HOSP_NAME, (SELECT T02049.T_LANG2_NAME FROM T02049 WHERE T02049.T_REFERRAL_CODE = T12065.T_REF_HOSP) CENTR_HOSP_NAME, T12065.T_BB_RECEIVED_DATE REQ_RCV_DATE, T12065.T_BB_RECEIVED_TIME REQ_RCV_TIME, T12065.T_BB_RECEIVED_FLAG REQ_RCV_FLAG, (SELECT MAX(T12067.T_BB_ISSUED_DATE) FROM T12067 WHERE T12067.T_SITE_CODE = T12065.T_SITE_CODE AND T12067.T_BLOOD_REQNO = T12065.T_BLOOD_REQNO) T_BB_ISSUED_DATE, (SELECT MAX(t12067.t_bb_issued_time) FROM t12067 WHERE t12067.t_site_code = t12065.t_site_code AND t12067.t_blood_reqno = t12065.t_blood_reqno) T_BB_ISSUED_TIME FROM T12065 LEFT JOIN T12067 ON T12065.T_SITE_CODE = T12067.T_SITE_CODE AND T12065.T_BLOOD_REQNO = T12067.T_BLOOD_REQNO LEFT JOIN T12091 ON T12065.T_BLOOD_REQNO = T12091.T_BLOOD_REQ_NO AND t12065.T_SITE_CODE = t12091.T_SITE_CODE LEFT JOIN T01009 ON T12065.T_DELIVERY_MAN = T01009.T_EMP_CODE ORDER BY to_char(t12065.t_blood_reqdate,'yyyyMMdd')||t12065.t_blood_reqtime DESC,t12065.T_SITE_CODE, t12065.t_blood_reqno DESC");
        }
    }
}