using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Web;

namespace BloodBankDAL.Repository.Query.Report
{
    public class R12016:CommonDAL
    {
        public DataTable getUnit(string T_SITE_CODE)
        {
            return Query($"SELECT T12019.T_UNIT_NO,T12022.T_DONATION_DATE FROM T12019 INNER JOIN T12022 ON T12019.T_UNIT_NO = T12022.T_UNIT_NO INNER JOIN T12017 ON T12017.T_REQUEST_ID = T12022.T_REQUEST_ID WHERE T_VIOROLOGY_RESULT = '1' AND T12017.T_SITE_CODE = '{T_SITE_CODE}' GROUP BY T12019.T_UNIT_NO,T12022.T_DONATION_DATE ORDER BY T12019.T_UNIT_NO");
        }
        public DataTable getPRCode(string l, string from , string to)
        {
            return Query($"SELECT T12011.T_PRODUCT_CODE,T12011.T_LANG{l}_NAME PRODUCT_DESC FROM T12019 INNER JOIN T12011 ON T12019.T_PRODUCT_CODE= T12011.T_PRODUCT_CODE WHERE T12019.T_UNIT_NO  BETWEEN '{from}' AND '{to}' GROUP BY T12011.T_PRODUCT_CODE,T12011.T_LANG{l}_NAME");
        }
        public DataTable getReport(string l, string from, string to, string prod)
        {
            string con = string.IsNullOrEmpty(from) && string.IsNullOrEmpty(to) ? "OR" : "AND";
            return Query($"SELECT T_UNIT_NO,T_DONATION_DATE,T_RH_NAME,T_RH,T_PRODUCT_CODE, T_EXPIRY_DATE, PRODUCTDESC, T_STORE_AT, VOLUME, (substr(NEG, 1, instr(NEG, ',', -1) - 1) || ' and ' || substr(NEG, instr(NEG, ',', -1) + 1)) NEG_VIRUS FROM(SELECT T12019.T_UNIT_NO, T12022.T_DONATION_DATE, T_RH_NAME, T_RH, T12019.T_PRODUCT_CODE,T12019.T_EXPIRY_DATE, T12011.T_LANG{l}_NAME PRODUCTDESC,T12011.T_STORE_AT,DECODE(T12022.T_APHERESIS, '1', T12022.T_BAG_WEIGHT, NULL) VOLUME, LISTAGG(T12033.T_LANG{l}_NAME, ', ') WITHIN GROUP(ORDER BY  T12033.T_VIRUS_CODE)  NEG FROM T12022 INNER JOIN T12019 ON T12019.T_UNIT_NO = T12022.T_UNIT_NO INNER JOIN T12004 ON T12004.T_ABO_CODE = T12019.T_SEG_ABO INNER JOIN T12011 ON T12011.T_PRODUCT_CODE = T12019.T_PRODUCT_CODE INNER JOIN T12034 ON T12034.T_UNIT_NO = T12019.T_UNIT_NO INNER JOIN T12033 ON T12033.T_VIRUS_CODE = T12034.T_VIRUS_CODE WHERE (('{prod}' IS NULL OR T12019.T_PRODUCT_CODE = '{prod}'){con}(T12019.T_UNIT_NO BETWEEN '{from}' AND '{to}')) AND T12019.T_VIOROLOGY_RESULT = '1'   GROUP BY T12019.T_UNIT_NO, T12022.T_DONATION_DATE, T_RH_NAME, T_RH, T12019.T_PRODUCT_CODE,T12019.T_EXPIRY_DATE, T12011.T_LANG{l}_NAME,T12011.T_STORE_AT, T12022.T_APHERESIS, T12022.T_BAG_WEIGHT) T ORDER BY T_UNIT_NO");
        }


       


    }
}